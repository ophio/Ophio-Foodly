"use strict";var app=angular.module("ophioFoodly",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","ngStorage","dangle","googlechart"]);app.config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",authenticationRequired:!0}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/category/:category",{templateUrl:"views/category.html",controller:"CategoryCtrl",authenticationRequired:!0}).when("/category/dashboard/:category",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl",authenticationRequired:!0}).otherwise({redirectTo:"/home"})}]).value("googleChartApiConfig",{version:"1",optionalSettings:{packages:["corechart"],language:"fr"}}),app.service("settings",function(){this.FIREBASE_URL="https://ophiofoodly.firebaseio.com/",this.AUTH_TOKEN_LENGTH=299,this.LOGIN_PROVIDER="google",this.CHECK_EMAIL_SUFFIX=!0,this.REQUIRED_EMAIL_SUFFIX="@ophio.co.in",this.isEmailAllowed=function(a){var b=this.REQUIRED_EMAIL_SUFFIX;return a.match(b+"$")[0]===b}}),app.service("loader",function(){this.loadingData=!0,this.loadChart=!0,this.getloadvalue=function(){return this.loadingData},this.getChartvalue=function(){return this.loadChart},this.setloadvalue=function(a){this.loadingData=a},this.setChartvalue=function(a){this.loadChart=a}}),app.service("AuthenticationService",["settings","$localStorage","$firebaseSimpleLogin","$location",function(a,b,c,d){this.isLoggedIn=function(){var a=this.getAuthToken();return Boolean(a)},this.getAuthToken=function(){if("undefined"!=typeof b.user){var a=b.user.firebaseAuthToken;if("undefined"!=typeof a)return a}return null},this.getCurrentUser=function(){return this.isLoggedIn?b.user:(alert("Your session has expired, Please login again."),void d.path("/login"))},this.tryLogin=function(){var e=c(new Firebase(a.FIREBASE_URL));e.$login(a.LOGIN_PROVIDER,{rememberMe:!0}).then(function(c){console.log(c),a.isEmailAllowed(c.email)?(b.user=c,d.path("/home")):(alert("Logging in with this email is not allowed"),d.path("/login"))},function(a){alert(a)})}}]),app.run(["$rootScope","$location","AuthenticationService",function(a,b,c){a.$on("$routeChangeStart",function(a,d){d.authenticationRequired&&!c.isLoggedIn()&&b.path("/login")})}]);var app=angular.module("ophioFoodly");app.controller("LoginCtrl",["$scope","settings","AuthenticationService",function(a,b,c){a.login=function(){return c.tryLogin()}}]);var app=angular.module("ophioFoodly");app.controller("HomeCtrl",["$scope","$location",function(a,b){a.show=function(a){b.path(a)}}]),app.controller("CategoryCtrl",["$scope","$timeout","loader","settings","AuthenticationService","$filter","$routeParams","$firebase",function(a,b,c,d,e,f,g,h){var i=new Firebase(d.FIREBASE_URL),j=i.child("availableItems"),k=i.child("votes"),l=function(){var a=f("date")(new Date,"yyyy-MM-dd"),b=k.child(a);return b};a.temp={},a.temp.addingItem=!1,a.temp.newItemName="",a.temp.loadingData=c.getloadvalue(),a.temp.currentCategory=g.category,a.availableItems=h(j).$asObject(),a.todaysVotes=h(l()).$asObject(),a.categories=[{href:"healthy",title:"Healthy Bites"},{href:"snacks",title:"Snacks"},{href:"drinks",title:"Drinks"},{href:"dashboard/daily",title:"Dashboard"}];var m=function(){navigator.onLine?$(".connectionalert").modal("hide"):($(".connectionalert").modal({backdrop:"static",show:!0}),b(m,1e3))};navigator.onLine||b(m,1e3),a.currentUser=e.getCurrentUser(),a.availableItems.$loaded().then(function(){c.setloadvalue(!1),a.temp.loadingData=c.getloadvalue()}),a.getVoteCount=function(a){return _.keys(a).length},a.upVoteItem=function(b){console.log(b);{var c=new Date,d=c.getHours();c.getMinutes()}if(d>=10&&17>=d){var e=l(),f=e.child(b),g=(h(f).$asObject(),h(f.child(a.currentUser.id)).$asObject());g.createdAt=(new Date).toISOString(),g.username=a.currentUser.displayName,g.$save()}else $(".votealert").modal("toggle")},a.addNewItem=function(){var b={name:a.temp.itemName,category:a.temp.currentCategory,createdBy:a.currentUser.id,creatorName:a.currentUser.displayName};a.availableItems.$add(b),a.temp.itemName="",a.temp.addingItem=!1}}]),app.controller("DashboardCtrl",["$scope","loader","settings","$filter","$firebase","$routeParams","$timeout",function(a,b,c,d,e,f){var g=new Firebase(c.FIREBASE_URL),h=g.child("availableItems"),i=g.child("votes"),j=function(){var a=d("date")(new Date,"yyyy-MM-dd"),b=i.child(a);return b};a.todaysVotes="",a.averageVotes={},a.chartCategory=f.category,a.temp={},a.temp.loadingChartData=b.getChartvalue(),e(g).$asObject().$loaded().then(function(){b.setChartvalue(!1),a.temp.loadingChartData=b.getChartvalue(),a.availableItems=e(h).$asArray(),a.availableItemsObj=e(h).$asObject(),a.totalVotes=e(i).$asArray(),a.todaysVotes=e(j()).$asArray(),a.todaysVotes.$loaded().then(function(){a.setDailyChartData(),a.calculate(),a.setAverageChartData()})}),a.setDailyChartData=function(){_.each(a.todaysVotes,function(b){console.log(b);var c=b.$id,d={c:[{v:a.availableItemsObj[c].name},{v:a.getVoteCount(c)}]};console.log(d),a.chartObjectDaily.data.rows.push(d)})},a.setAverageChartData=function(){_.each(a.averageVotes,function(b,c){var d={c:[{v:c},{v:b}]};a.chartObjectAll.data.rows.push(d)})},a.calculate=function(){var b=a.availableItems,c=a.totalVotes;_.each(b,function(b){var d=0;_.each(c,function(c){_.has(c,b.$id)&&(d+=a.getVoteCount(b))}),a.averageVotes[b.name]=d})},a.getVoteCount=function(a){return _.keys(a).length},a.chartObjectDaily={},a.chartObjectAll={},a.chartObjectDaily.data={cols:[{id:"t",label:"Item Name",type:"string"},{id:"s",label:"Votes",type:"number"}],rows:[]},a.chartObjectAll.data={cols:[{id:"t",label:"Item Name",type:"string"},{id:"s",label:"Votes",type:"number"}],rows:[]},a.chartObjectDaily.type="BarChart",a.chartObjectDaily.options={title:"Audience Poll"},a.chartObjectAll.type="BarChart",a.chartObjectAll.options={title:"Overall Statistics"}}]);